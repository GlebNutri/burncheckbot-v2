name: Deploy to TimeWeb
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to TimeWeb server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.TIMEWEB_HOST }}
          username: ${{ secrets.TIMEWEB_USERNAME }}
          key: ${{ secrets.TIMEWEB_SSH_KEY }}
          port: ${{ secrets.TIMEWEB_PORT }}
          script: |
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –±–æ—Ç–∞ –Ω–∞ TimeWeb..."
            
            # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /root/burncheckbot-v2
            
            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞..."
            supervisorctl stop burncheckbot 2>/dev/null || true
            pkill -f "python.*bot.py" 2>/dev/null || true
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
            echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
            git pull origin main
            
            # –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            echo "üêç –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
            source venv/bin/activate
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            echo "üìö –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            pip install -r requirements.txt
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è .env —Ñ–∞–π–ª–∞
            if [ ! -f ".env" ]; then
              echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ —Å —Ç–æ–∫–µ–Ω–æ–º –±–æ—Ç–∞."
              exit 1
            fi
            
            # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
            echo "üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
            supervisorctl start burncheckbot
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
            echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
            sleep 5
            supervisorctl status burncheckbot
            
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
            
      - name: Check deployment status
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.TIMEWEB_HOST }}
          username: ${{ secrets.TIMEWEB_USERNAME }}
          key: ${{ secrets.TIMEWEB_SSH_KEY }}
          port: ${{ secrets.TIMEWEB_PORT }}
          script: |
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞..."
            supervisorctl status burncheckbot
            
            echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
            tail -10 /var/log/burncheckbot.out.log || echo "–õ–æ–≥–∏ –ø–æ–∫–∞ –ø—É—Å—Ç—ã"
            
            echo "‚ùå –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏:"
            tail -10 /var/log/burncheckbot.err.log || echo "–û—à–∏–±–æ–∫ –Ω–µ—Ç" 